---
title: æ‰‹æŠŠæ‰‹æ•™ä½ åœ¨æµè§ˆå™¨ä¸­å¤„ç†æµå¼ä¼ è¾“(Event Stream/SSE)
date: 2025-04-01 22:36:52
tags:
- SSE
- å‰ç«¯
categories: å‰ç«¯
---

> å‰æ–‡ï¼š[æ‰‹æŠŠæ‰‹æ•™ä½ åœ¨æµè§ˆå™¨å’ŒRUSTä¸­å¤„ç†æµå¼ä¼ è¾“](https://juejin.cn/post/7473040165489983514) æåˆ°å¦‚ä½•ç®€å•çš„å¤„ç†æµå¼è¾“å‡ºï¼Œä½†æ˜¯åæ¥å‘ç°è¿™ä¸ªå†™æ³•æœ‰bugï¼Œä¸‹é¢è®²è§£ä¸€ä¸‹æ›´å¥½çš„å†™æ³•

é¡ºä¾¿è¡¥å……ä¸€ä¸‹ï¼Œä¸Šä¸€ç¯‡æ–‡ç« æåˆ°çš„`IterableReadableStream`æ¥è‡ª`@langchain/core`ï¼Œä½ å¯ä»¥è¿™æ ·å¯¼å…¥ä½¿ç”¨ï¼š

```js
import { IterableReadableStream } from '@langchain/core/utils/stream'
```

## å¤„ç†Event Stream

é™¤äº†ä¸Šä¸€ç« çš„ndjsonä»¥å¤–ï¼Œæœ€å¸¸ç”¨å°±æ˜¯**Event Stream**äº†ï¼ŒåŒ…æ‹¬OpenAiç­‰ä¸€ä¼—aiæœåŠ¡æä¾›å•†éƒ½ä¼šæä¾›sseæ¥å£ï¼Œå¹¶ä¸”ä»¥**Event Stream**çš„æ ¼å¼è¿›è¡Œè¾“å‡ºï¼Œå…ˆæ¥çœ‹çœ‹aiæ˜¯æ€ä¹ˆç†è§£**Event Stream**å’Œ**SSE**çš„ï¼š

**Server-Sent Events (SSE)** ï¼Œä¸€ç§åŸºäº HTTP çš„è½»é‡åè®®ï¼Œå…è®¸æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€å®æ—¶æ•°æ®æµã€‚

#### **SSE æ ¼å¼è§„èŒƒ**ï¼š

*   æ•°æ®é€šè¿‡ HTTP æµå¼ä¼ è¾“ï¼Œå†…å®¹ç±»å‹ä¸ºÂ `text/event-stream`ã€‚

*   æ¯æ¡äº‹ä»¶ç”±å­—æ®µç»„æˆï¼Œç”¨æ¢è¡Œç¬¦åˆ†éš”ã€‚å­—æ®µåŒ…æ‹¬ï¼š

    *   `data`: äº‹ä»¶çš„å…·ä½“å†…å®¹ï¼ˆå¿…å¡«ï¼‰ã€‚
    *   `event`: è‡ªå®šä¹‰äº‹ä»¶ç±»å‹ï¼ˆå¯é€‰ï¼‰ã€‚
    *   `id`: äº‹ä»¶å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆå¯é€‰ï¼‰ã€‚
    *   `retry`: é‡è¿æ—¶é—´ï¼ˆæ¯«ç§’ï¼Œå¯é€‰ï¼‰ã€‚

**ç¤ºä¾‹**ï¼š

```plaintext
event: status_update
data: {"user": "Alice", "status": "online"}

id: 12345
data: This is a message.

retry: 3000
```

é‚£å†æ¥çœ‹çœ‹aiè¾“å‡ºçš„ç»“æœï¼š

![image.png](https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/95ef7a7f980a460f9073caa613034989~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qGc5ZC56Zuq:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTE3OTA5MTkwMTA5ODI2OSJ9&rk3s=f64ab15b&x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&x-orig-expires=1758206248&x-orig-sign=dzwqXm56qM%2Bh5ykSNVxYex9EMTM%3D)

å¾ˆæ ‡å‡†çš„`text/event-stream`æ ¼å¼

### ä½¿ç”¨langchainjså¤„ç†

ä½ ä»¥ä¸ºæˆ‘è¦åƒä¸Šä¸€ç¯‡ä¸€æ ·å¼€å§‹æ‰‹æ“å¤„ç†ä»£ç äº†å—ï¼Œno no noï¼Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨langchainjsè¿›è¡Œå¤„ç†ï¼ŒåŸå› åé¢ä¼šæåˆ°ã€‚

è¿™é‡Œæ¨èä¸€ä¸ªfetchå°è£…å·¥å…·ï¼š`ofetch`ï¼Œä¸€ä¸ªç±»ä¼¼`axios`çš„åº“ï¼Œä½œç”¨å¤§å®¶åº”è¯¥éƒ½æ‡‚äº†å§ï¼Œè¿™é‡Œæˆ‘æ‹¿ç«å±±çš„æ¥å£æ¥æ¼”ç¤ºï¼š

```js
// vite.config.js
export default defineConfig({
  base: "/",
  server: {
    proxy: {
      "/huoshan": {
        changeOrigin: true,
        ws: true,
        secure: false,
        target: "https://ark.cn-beijing.volces.com",
        rewrite: (path) => path.replace(/^\/huoshan/, ""),
      },
    },
  },
});

// vue.config.js
module.export = {
  devServer: {
    compress: false, // é‡ç‚¹ï¼ï¼ï¼ä¸å…³é—­åˆ™æœ‰å¯èƒ½å¯¼è‡´æ— æ³•æ­£å¸¸æµå¼è¿”å›
    proxy: {
      '/huoshan': {
        target: 'https://ark.cn-beijing.volces.com', // ä»£ç†
        changeOrigin: true,
        ws: true,
        secure: false,
        pathRewrite: {
          '^/huoshan': '',
        },
      },
    }
  }
}
```

å¦‚æœæ˜¯webpackçš„è¯ï¼Œä¸€å®šè¦å…³é—­`devServer`çš„`compress`ï¼Œä¸ç„¶ä¼šå¯¼è‡´æ•´ä¸ªè¯·æ±‚ç»“æŸæ‰è¿”å›ï¼Œè¿™æ ·å°±ä¸æ˜¯æµå¼è¾“å‡ºäº†ã€‚

```js
// request.js

import { ofetch } from "ofetch";

export const fetchRequest = ofetch.create({
  baseURL: '/huoshan',
  timeout: 60000,
  onRequest({ options }) {
    options.headers.set('Authorization', 'Bearer xxxxx') // æ›¿æ¢ç«å±±apiçš„key
  },
})
```

```js
import { fetchRequest } from "./request";
import { convertEventStreamToIterableReadableDataStream } from "@langchain/core/utils/event_source_parse";

async function test() {
  const res = await fetchRequest("/api/v3/chat/completions", {
    responseType: "stream",
    method: "post",
    body: {
      model: "deepseek-v3-250324",
      messages: [
        {
          role: "user",
          content: "ä½ æ˜¯è°ï¼Ÿ",
        },
      ],
      stream: true,
    },
  });
  const stream = convertEventStreamToIterableReadableDataStream(res);
  for await (const chunk of stream) {
    console.log(chunk);
  }
}
test()
```

![image.png](https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/98259011969b4f3fade740694a9ab272~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qGc5ZC56Zuq:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTE3OTA5MTkwMTA5ODI2OSJ9&rk3s=f64ab15b&x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&x-orig-expires=1758206248&x-orig-sign=Zgw2lhq5OrPnR%2FAsv6kCBzNJkcI%3D)

è¿”å›æ­£å¸¸ï¼Œä¸è¿‡è¦æ³¨æ„ï¼Œç»“å°¾æœ‰ä¸ª`[DONE]`ï¼Œæ‰€ä»¥ä¸èƒ½æ— è„‘ååºåˆ—åŒ–ï¼Œ

```js
for await (const chunk of stream) {
  if (chunk !== '[DONE]') {
    console.log(JSON.parse(chunk))
  }
}
```

è¿™æ ·å°±æ‹¿åˆ°æ¯ä¸ªchunkäº†ï¼Œå½“ç„¶ä½ å¯ä»¥å°†testæ–¹æ³•æ”¹æˆç”Ÿæˆå™¨ï¼Œç„¶å`for`é‡Œé¢`yield JSON.parse(chunk)`

### ä¸ºä»€ä¹ˆè¦ç”¨langchainjså°è£…å¥½çš„æ–¹æ³•å¤„ç†

æ—¢ç„¶å¤§å®¶éƒ½çŸ¥é“æµå¼è¾“å‡ºæ˜¯ä¸€ä¸ªä¸€ä¸ªchunkçš„æ–¹å¼è¿”å›ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯æœ‰å¯èƒ½ä¸€è¡Œçš„æ–‡æœ¬ï¼Œæ‹†åˆ†æˆä¸¤ä¸ªchunkï¼ˆåœ¨jsçœ‹æ¥æ˜¯ArrayBufferï¼‰ï¼Ÿè€Œä¸€ä¸ªutf8å­—ç¬¦æ˜¯å®šé•¿çš„ï¼Œå¯èƒ½æ˜¯1-3å­—èŠ‚ï¼Œé‚£æ˜¯ä¸æ˜¯æœ‰å¯èƒ½åœ¨æŸä¸ªå­—ç¬¦çš„æ—¶å€™ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†å­—èŠ‚æ‹†åˆ†åˆ°ä¸€ä¸ªchunkï¼Œç„¶åå‰©ä¸‹éƒ¨åˆ†å­—èŠ‚æ‹†åˆ†åˆ°ä¸‹ä¸€ä¸ªchunkï¼Ÿ

è¿™æ ·å°±ä¼šå¯¼è‡´ä½ åœ¨decodeçš„æ—¶å€™å‘ç”ŸæŠ¥é”™ï¼Œæ— æ³•æ­£å¸¸decodeæˆæ–‡å­—ï¼Œæ‰€ä»¥langchainjsçš„æ–¹æ³•è€ƒè™‘åˆ°è¿™ä¸ªæƒ…å†µï¼š

![image.png](https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/7df2234ba0ba49339b4787346d7e9a4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qGc5ZC56Zuq:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTE3OTA5MTkwMTA5ODI2OSJ9&rk3s=f64ab15b&x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&x-orig-expires=1758206248&x-orig-sign=Jq3QgZnipDynEBf%2FdeedUF0xKCY%3D)

ä»£ç åœ¨ï¼š<https://github.com/langchain-ai/langchainjs/blob/5100a9d0a1eda7b7998dd40624abdd3ff3002b36/langchain-core/src/utils/event_source_parse.ts#L88-L165>

## å…¶ä»–å…³æ³¨ç‚¹

### ä½¿ç”¨ä»£ç†æ—¶éœ€è¦æ³¨æ„

ä¸Šé¢çš„webpacké…ç½®å·²ç»è®²è§£äº†ä¸€ä¸‹devServeråº”è¯¥æ€ä¹ˆé…ç½®æ‰èƒ½æµå¼è¾“å‡ºã€‚è¿˜æœ‰å°±æ˜¯ä½¿ç”¨nginxä»£ç†çš„æ—¶å€™ä¹Ÿéœ€è¦ä¿®æ”¹ä¸€ä¸‹é…ç½®ï¼š

```
    server {
    	listen 80;
    	location /huoshan/ {
                    # http1.1æ‰æ”¯æŒé•¿è¿æ¥
    		proxy_http_version 1.1;
    		# å…³é—­ä»£ç†ç¼“å†²
    		proxy_buffering off;
    		# è®¾ç½®ä»£ç†ç¼“å†²åŒºå¤§å°
    		proxy_buffer_size 10k;
    		# è®¾ç½®ä»£ç†ç¼“å†²åŒºæ•°é‡å’Œå¤§å°
    		proxy_buffers 4 10k;
    		proxy_set_header Host $host;
    		proxy_set_header X-Real-IP $remote_addr;
    		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    		proxy_pass https://ark.cn-beijing.volces.com/;
    	}


    }
```

å…¶å®å°±æ˜¯å…³é—­ä¸€äº›ä»£ç†ç¼“å†²ï¼Œä»¥åŠè®¾ç½®ä¸€ä¸‹ç¼“å†²åŒºï¼Œä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾ç½®ï¼Œè¿™é‡Œæœ‰è¯·æ‡‚nginxé…ç½®çš„å¤§ä½¬ç»†è¯´ä¸€ä¸‹ğŸ˜œ
